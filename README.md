农智谷
农智科技团队；彭竣；李丹；徐紫瑜；李松；居本祥
摘要	
2022年10月，习近平总书记在党的二十大报告中强调，全方位夯实粮食安全根基牢牢把握粮食安全主动权[1]。农作物病虫害是影响粮食安全的关键因素，但传统方法存在监测不及时、治疗延误及农药滥用等问题，不仅直接影响了农作物的产量和质量，还加剧了环境污染，对经济社会环境造成了负面影响。
为了有效应对这一挑战，我们推出了农智谷——一款集成多项先进技术的智能化农业监测系统。该系统利用传感器技术，能够实时监测农田中的农作物生长状态以及土壤温湿度等关键参数，确保农民能够掌握农田环境的实时动态。同时，通过集成机器学习和图像处理技术，农智谷的视觉检测模块能够准确识别农作物病虫害，为农民提供及时的预警信息。此外，系统通过LCD屏幕直观展示关键数据和解决方案，帮助农民轻松管理农田，提升农作物产量和质量。
农智谷系统由星火一号主控板、视觉检测模块（vision broad）、温湿度传感器和LCD屏幕显示模块四大核心模块组成，这些模块协同工作，共同实现病虫害检测、温湿度监测、屏幕显示及云端数据传输与查看等多项功能。农智谷系统的多模块集成设计，有效提高了系统的整体性能和功能。各模块间互相协作，高效地提升了系统性能，为农业生产提供实时准确支持，助力农民丰收，促进农业可持续发展。  
第一部分  作品概述
1.1功能与特性
(1)病虫害检测：结合视觉模块，装置能够对农作物进行图像识别，识别出可能存在的病虫害问题，提供及时方案处理和数据收集。
(2)温湿度监测：通过温湿度传感器模块，装置能够实时监测环境中的温度和湿度数据，帮助用户了解植物生长环境的变化，并且给出湿度建议。
(3)屏幕显示：在lvgl显示屏上显示处理建议，根据视觉分析结果和传感器数据。可以向用户提供实时反馈，以保护植物生长环境。结合视觉模块和传感器模块数据，为用户提供有效的病虫害识别和管理建议。 
(4)云端数据传输与查看：装置可以将采集到的数据上传至云端存储，用户可以随时通过手机或电脑上云查看实时数据和历史记录，方便远程监控和管理。
(5)用户友好性：装置操作简单，界面友好，适用于农业生产者和爱好者使用，提升种植效率和作物品质。
1.2应用领域
(1)农作物种植：农户和农业专业人员可以使用本产品对种植的作物进行监测，及时发现病虫害的迹象，从而采取适当的防治措施，减少作物的病害危害。
(2)温室种植：在温室种植领域，本产品可用于监测温室内作物的病虫害情况，帮助种植者及时调整环境和管理措施，保证作物的健康生长。
(3)生态系统保护：农户对农药使用规范的认知不足，过度依赖农药进行治理[2]。本产品可提供更规范的病虫害治理法，减轻对土壤生态系统的负面影响。

1.3主要技术特点
采用多模块集成设计，融合了主控核心板、视觉检测模块、温湿度传感器等组件，提高农业病虫害检测系统的整体性能和功能。使用RTT官方机器视觉开发板Vision Board，能够高清采集病虫害部位的图像，并实现图像处理和识别技术，准确快速地检测作物上的病虫害问题；搭载温湿度传感器，实时监测环境的温度和湿度数据，为病虫害的发生提供环境数据支持，帮助农民及时调整环境条件；进行相关数据传输与处理，实现对采集的病虫害图像和环境数据进行处理和存储，并将数据上云[4]，用户可在手机端或电脑端实时查看农作物健康情况数据。最后将相关数据和防范措施和显示在LCD屏幕，用图形与文字结合的方式，更加通俗易懂。

1.4主要性能指标
(1)主控芯片采用STM32F407ZGT6，主频168GHz，性能强劲。
(2)视觉检测模块（Vision Board）：采用RA8芯片，内核：480 MHz Arm Cortex-M85。
(3)温度测量范围：支持-30°到70°的温度测量，具有较高的测量精度。
湿度测量范围：测量范围为：0～100%，获取准确湿度数据。
稳定时间：＜1 秒，响应时间：＜1 秒。
(4)模型性能：
采用轻量级的MobileNetV2模型（如图 2）进行迁移学习，能识别八种农作物上共35余种病虫害类型。其中，土豆病虫害分类模型的F1分数达81.4%，推理时间为34ms，如图 1所示，其余农作物种类的分类模型均在80%以上，推理时间在40ms以下，均满足项目需求。

图 1土豆病虫害模型混淆矩阵

图 2 CNN神经网络结构[5]
(5)代码性能：采用RTOS管理多个线程，确保UART、485、LCD等模块能同时运行并实时更新数据。

1.5主要创新点
（1）数据云端存储与分析：借助云端技术，将采集到的病虫害数据和环境数据进行存储和分析，为实现数据共享、追溯、大数据分析等提供支持，用户可在手机端或电脑端实时查看农作物健康情况数据，为农业生产提供更科学的决策。
（2）多模块一体化设计：创新地将主控核心板、视觉检测模块和温湿度传感器进行一体化设计，实现多模块之间高效的数据交互和协作，简化设备结构，提高系统整体性能。
（3）智能图像识别技术：引入先进的图像处理和识别算法，通过视觉检测模块对病虫害部位的图像进行高清采集和处理，实现智能识别和分析，提高检测的准确性和效率。
（4）环境数据与病虫害关联：利用温湿度传感器实时监测环境的温湿度数据，与病虫害检测数据进行关联分析，探索环境因素对病虫害发生的影响机制，为农民提供更准确的防治建议。

1.6设计流程
（1）需求分析：确定系统的核心功能， 分析用户需求
（2）硬件选型与集成：选择合适的传感器和监测设备，将主控核心板、视觉检测模块、温湿度传感器等模块进行一体化集成。
（3）软件开发：开发数据采集与处理软件，建立预测模型，开发用户交互界面。 
（4）系统集成与测试：集成硬件和软件系统，进行系统测试，训练并验证预警模型，提高预警的准确度。
（5）部署与运营：将系统部署到农田中，开始实际运行。
第二部分  系统组成及功能说明
22.1整体介绍
系统主要包括主控模块、485传感器、VisionBoard视觉模块以及RW007 WIFI模块。视觉模块主要负责OpenMV视觉识别处理，包括离线训练模型。当按键选择要识别的农作物种类时，识别模块开始工作。首先，摄像头完成图像信息采集，然后将采集到的图像与处理器中的模型进行比对，生成识别结果（农作物病虫害种类），并将结果发送给主控模块。主控程序负责解析并显示从OpenMV获取的数据。系统的结构框图如图 3所示。



图 3系统结构框图

2.2硬件系统介绍
2.2.1 机械设计介绍
外壳采用2mm厚度亚克力板组装，亚克力板设计如图 4所示。

图 4 CAD外壳设计
2.2.2电路各模块介绍
(1)供电电源
供电模块采用TP5400的1A 锂电池充电和5V/1A升压控制芯片，设计U4用于连接开关，U1、U2、U3三个5V输出端子，可输出最大1A的电流，满足设计产品需要。

图 5供电模块正面                          图 6供电模块背面

(2)土壤温湿度传感器
采用隔离型土壤温湿度传感器，可用于测量土壤温度、湿度参数，通过RS485（标准 Modbus-RTU 协议，设备默认地址：01）发送如图 7所示查询码，反馈传感器测得数据，并在RTOS的操作系统下创建单独线程，不断更新传感器数据。

图 7土壤传感器查询数据
(3)VisionBoard视觉模块
基于RT Thread给VisionBoard视觉模块烧写OpenMV固件，基于OpenMV IDE进行代码编写与调试，并借助AI训练平台Edge Impulse，快速地训练多个农作物病虫害模型。
(4)3.2寸LCD
LCD采用ILI9431驱动芯片，通讯协议为SPI，我们把LCD挂载到SPI1总线上，并为其移植驱动函数。
(5)WIFI RW007
RW007 是由上海睿赛德电子科技有限公司开发的高速 WiFi 模块，模块基于 Realtek RTL8710BN（Ameba Z 系列） WIFI SOC，使用 SPI/UART 与主机通信 ，支持 IEEE 802.11b/g/n 网络、 WEP/WPA/WPA2 加密方式和 STA 和 AP 模式。
通过WiFi能够连接到无线网络，使设备能够通过WiFi网络与互联网通信，实现实时检测数据和远程查看。设备实时监测数据并将数据及时传输至云端，实现数据存储、分析和云端处理，为用户提供更多智能的建议，也可以通过手机App或电脑远程实时查看设备状态。
(6)交互按键
使用星火一号开发板四个自带按键，复用GPIO为下拉输入模式，再RTOS操作系统创建单独线程，循环执行，不断检测按键按下状态，并添加防抖，记录上一次按下比较时间，防止误触。

图 8按键接线图


2.3软件系统介绍
2.3.1软件整体介绍


图 9流程图

2.3.2软件各模块介绍（根据总体框图，给出各模块的具体设计说明。从顶层到底层逐次给出各函数的流程图及其关键输入、输出变量）；

(1)主线程如图 10所示，首先判断按键所选择的农作物种类，调用串口函数向视觉模块发送识别种类，并接收回馈数据和数据库病虫害防护措施比对，将结果显示在LCD上。

图 10 主线程
(2)读取按键状态线程流程如图 11所示，函数首先初始化按键GPIO，然后创建并启动RT-Thread线程不断进行按键检测。该线程周期性地调用按键读取函数，结合防抖逻辑确保稳定检测，避免误判。检测到按键按下后，输出按键信息。

图 11读取按键状态线程
(3)传感器数据采集线程流程如图 12所示，代码首先初始化串口设备，并启动"sensor"线程，sensor_thread_entry循环调用Sensor485data，通过RS485与传感器通信，接收解析数据更新湿度温度变量并显示。关键输入为RS485串口数据，输出为解析后的湿度和温度值。

图 12传感器数据采集线程
(4)串口数据接收函数流程如图 13所示，首先初始化串口设备并配置参数，设置接收回调函数处理数据。数据通过消息队列传递给serial_thread_entry线程，线程解析消息提取标识符和概率值，存储于全局变量uart_flag和probability。关键输入为按键所选择农作物的代号，返回值为解析得到的标识符和概率值，供后续应用逻辑使用。

图 13串口数据接收线程
(5)ILI9341 LCD驱动函数流程图如图 14所示，代码通过spi_lcd_init初始化SPI设备以通信，LCD_Init初始化LCD并执行复位操作。LCD_WR_REG和LCD_WR_DATA通过SPI写入LCD初始化数据。

图 14 ILI9341 LCD驱动函数
(6)OpenMv部分代码流程图如图 15所示，首先初始化摄像头、UART，然后判断星火一号要是别的农作物种类，然后加载训练的模型并识别出结果，最后将识别结果打包发送到星火一号进行下一步处理。

图 15 OpenMV函数

第三部分  完成情况及性能参数
阐述最终实现的成果（图文结合，实物照片为主）
3.1 整体介绍（整个系统实物的正面、斜45°全局性照片）

图 16系统实物正面

图 17系统斜45°全局性照片

考虑星火一号核心控制板和VisionBoard视觉模块等多个主要板块大小及排版布置，设计外壳造型，整体展现出轻便的特点。

3.2 工程成果（分硬件实物、软件界面等设计结果）
3.2.1 机械成果；（实物照片）

图 18农智谷机械成果
外壳主要材质：亚克力板
3.2.2 电路成果；
				
图 13供电模块正面								图 14供电模块背面

3.2.3 软件成果；
将训练好的苹果病虫害模型导入视觉模块，用OpenMV调试，显示当前病虫害种类为苹果黑星病，如图 19置信度高达99%。


图 19 OpenMV在苹果种类下识别结果

本系统采用的是RT-Thread开发平台进行农智谷的控制系统设计。使用ali云平台完成手机端查看数据。
在RT-Thread开发平台编写各部分初始化与运行代码，使各部分正常运行。

图 20 RT Thread开发平台界面
阿里云查看湿度

图 21阿里云界面


3.3 特性成果（逐个展示功能、性能参数等量化指标）（可加重要仪器测试或现场照片）；
1.温湿度传感器检测数据并显示（可知当前土壤温湿度）

图 22功能展示1
2.视觉模块识别结果与建议（显示当前病虫害给出防治建议）

图 23 功能展示2
3.云端数据查看（可查看湿度）

图 24功能展示3
第四部分  总结
454.1 可扩展之处
(1)增加外设设备，获得更多数据，诸如增加土壤盐分，磷分传感器，为农业生产提供更加全面的管理建议。
(2)增加图片训练集，提高机器学习视觉识别的准确度。
(3)增加可识别农作物种类，覆盖大部分农作物，满足不同地区和不同作物的农业生产需求。
(4)加入LVGL开发，增加中文字库，为用户提供更加人性化的交互界面。
(5)搭配农田巡逻机器人，实现自动化及远程监控。
4.2 心得体会
本次比赛让我们小组收获到与以往不同的实践经验，并且从零开始走到现在感触十分深刻。本次学习也让我们也对RT-Thread有了更加深入的学习和理解，我们学习了RT-Thread的内核，线程管理及其以及通信等方面内容，并且能够使用RT-Thread开发平台编写代码。通过这次比赛的项目实践，积累到许多调试与整合经验，增强了实践能力和往前走的决心。最后感谢主办方提供了优秀平台以供学习，不仅是在RT-Thread论坛中受到了指导，也得到了展示自己的机会，学到很多知识，希望以后可以在RT-Thread论坛帮助其他人，贡献出自己的力量。

第五部分  参考文献
[1]崔梦银,邓茵,崔盼盼.基于深度学习的农作物病虫害图像识别方法[J].沧州师范学院学报,2024,40(1):15-21.
[2]朱翠霞.农作物病虫害防治中农药使用污染问题及治理对策[J].河北农机,2024(7):67-69.
[3]朱晓智,张蕾,韩媛媛,等.基于RT-thread的小麦病虫害检测系统的研究与应用[J].河南科技,2023,42(18):23-26.
[4]谢莹.基于RT-Thread的智慧农业大棚监控系统设计[J].电子技术与软件工程,2023(6):206-209.
[5]钱铖,沈凯文,王淳,王小英.一种基于MobileNet模型的医疗废弃物品收集小车[J].常熟理工学院学报,2023,37(5):51-56.

第六部分  附录
在嵌入式系统开发的道路上，开源精神如同一盏明灯，为我们指引前行的方向。开源不仅仅是技术上的分享和交流，更是一种共同进步的理念。它让更多的开发者能够共享和改进软件，推动技术的快速发展和创新。在开源的世界里，我们能够借助他人的经验和成果，避免重复造轮子，提高开发效率。同时，参与开源项目也能积累宝贵经验，拓展视野，共同推动整个行业的发展。我们非常荣幸能够贡献我们参加嵌入式大赛的开源项目，您可以在这里找到它：[https://github.com/PPP614/RT-Thread_rt-spark.git]。
